<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ранжирование напитков</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.4;
            touch-action: manipulation;
            overflow: hidden;
            height: 100vh;
        }
        
        #app {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        
        header {
            background-color: #fff;
            padding: 16px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: relative;
            z-index: 10;
            flex-shrink: 0;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        h1 {
            font-size: 18px;
            font-weight: 600;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 16px;
            color: #007AFF;
            cursor: pointer;
        }
        
        .content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            -webkit-overflow-scrolling: touch;
        }
        
        .instruction {
            margin-bottom: 16px;
            font-size: 15px;
            color: #666;
        }
        
        .ranking-list {
            list-style: none;
            margin-bottom: 16px;
        }
        
        .ranking-item {
            background-color: #fff;
            border-radius: 10px;
            padding: 16px;
            margin-bottom: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            display: flex;
            align-items: center;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            position: relative;
            touch-action: none;
        }
        
        .ranking-item.dragging {
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transform: scale(1.02);
        }
        
        .ranking-item.placeholder {
            background-color: transparent;
            box-shadow: none;
            visibility: hidden;
            height: 0;
            padding: 0;
            margin: 0;
        }
        
        .ranking-item.disabled {
            opacity: 0.6;
        }
        
        .item-number {
            width: 28px;
            height: 28px;
            background-color: #f0f0f0;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            font-weight: bold;
            font-size: 14px;
            flex-shrink: 0;
        }
        
        .item-text {
            flex: 1;
            font-size: 16px;
        }
        
        .item-dash {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            font-weight: bold;
            font-size: 18px;
            flex-shrink: 0;
        }
        
        .handle {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #ccc;
            flex-shrink: 0;
        }
        
        .handle::after {
            content: "≡";
            font-size: 20px;
        }
        
        footer {
            background-color: #fff;
            padding: 16px;
            box-shadow: 0 -2px 4px rgba(0,0,0,0.1);
            flex-shrink: 0;
        }
        
        .continue-btn {
            background-color: #007AFF;
            color: white;
            border: none;
            border-radius: 10px;
            padding: 14px;
            width: 100%;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }
        
        .continue-btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        
        .special-buttons {
            margin-bottom: 16px;
        }
        
        .special-btn {
            background: none;
            border: none;
            color: #007AFF;
            padding: 12px 0;
            width: 100%;
            text-align: center;
            font-size: 16px;
            cursor: pointer;
        }
        
        .special-btn:not(:last-child) {
            border-bottom: 1px solid #eee;
        }
        
        .logo {
            text-align: center;
            margin-top: 16px;
            font-size: 12px;
            color: #999;
        }
        
        .drag-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1000;
            display: none;
        }
    </style>
</head>
<body>
    <div id="app">
        <header>
            <div class="header-content">
                <h1>Ранжирование напитков</h1>
                <button class="close-btn">Закрыть</button>
            </div>
        </header>
        
        <div class="content">
            <p class="instruction">Распределите варианты в порядке важности (сверху — более важный, снизу — менее важный)</p>
            
            <ul class="ranking-list">
                <li class="ranking-item">
                    <div class="item-number">1</div>
                    <div class="item-text">Крепкий черный кофе с молоком и корицей</div>
                    <div class="handle"></div>
                </li>
                <li class="ranking-item">
                    <div class="item-number">2</div>
                    <div class="item-text">Традиционный квас с ржаным хлебом и медом</div>
                    <div class="handle"></div>
                </li>
                <li class="ranking-item">
                    <div class="item-number">3</div>
                    <div class="item-text">Чай с жасмином и медом, поданный горячим</div>
                    <div class="handle"></div>
                </li>
                <li class="ranking-item">
                    <div class="item-number">4</div>
                    <div class="item-text">Ароматный чай с лимоном и имбирем</div>
                    <div class="handle"></div>
                </li>
                <li class="ranking-item">
                    <div class="item-number">5</div>
                    <div class="item-text">Нежный смузи из манго и ананаса</div>
                    <div class="handle"></div>
                </li>
                <li class="ranking-item">
                    <div class="item-number">6</div>
                    <div class="item-text">Классический коктейль Мохито с ромом и свежей мятой</div>
                    <div class="handle"></div>
                </li>
                <li class="ranking-item">
                    <div class="item-number">7</div>
                    <div class="item-text">Шоколадный фраппе с взбитыми сливками</div>
                    <div class="handle"></div>
                </li>
                <li class="ranking-item">
                    <div class="item-number">8</div>
                    <div class="item-text">Классический молочный коктейль с клубникой</div>
                    <div class="handle"></div>
                </li>
                <li class="ranking-item">
                    <div class="item-number">9</div>
                    <div class="item-text">Освежающий лимонад с мятой и лаймом</div>
                    <div class="handle"></div>
                </li>
                <li class="ranking-item">
                    <div class="item-number">10</div>
                    <div class="item-text">Коктейль Пина Колада с ананасом и кокосом</div>
                    <div class="handle"></div>
                </li>
            </ul>
            
            <div class="special-buttons">
                <button class="special-btn" id="accept-order">Принять текущий порядок</button>
                <button class="special-btn" id="difficult-answer">Затрудняюсь ответить</button>
            </div>
        </div>
        
        <footer>
            <button class="continue-btn" disabled>Продолжить</button>
            <div class="logo">SurveySparrow</div>
        </footer>
        
        <div class="drag-overlay"></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const list = document.querySelector('.ranking-list');
            const items = document.querySelectorAll('.ranking-item');
            const acceptOrderBtn = document.getElementById('accept-order');
            const difficultAnswerBtn = document.getElementById('difficult-answer');
            const continueBtn = document.querySelector('.continue-btn');
            const specialButtons = document.querySelector('.special-buttons');
            const dragOverlay = document.querySelector('.drag-overlay');
            const content = document.querySelector('.content');
            
            let dragItem = null;
            let placeholder = null;
            let isDragging = false;
            let isScrolling = false;
            let startY = 0;
            let startX = 0;
            let startScrollTop = 0;
            let touchStartTime = 0;
            let dragThreshold = 8; // пикселей для активации drag
            let timeThreshold = 300; // миллисекунд для активации drag
            let touchIdentifier = null;
            let hasInteracted = false;
            let dragActivated = false;
            let currentY = 0;
            let initialIndex = 0;
            
            // Инициализация элементов
            function initItems() {
                items.forEach(item => {
                    item.addEventListener('touchstart', handleTouchStart, { passive: true });
                    item.addEventListener('touchmove', handleTouchMove, { passive: false });
                    item.addEventListener('touchend', handleTouchEnd);
                    item.addEventListener('touchcancel', handleTouchEnd);
                });
            }
            
            // Обработка начала касания
            function handleTouchStart(e) {
                if (e.touches.length !== 1) return;
                
                const touch = e.touches[0];
                touchIdentifier = touch.identifier;
                startY = touch.clientY;
                startX = touch.clientX;
                startScrollTop = content.scrollTop;
                touchStartTime = Date.now();
                dragItem = e.currentTarget;
                
                // Запоминаем начальную позицию элемента
                initialIndex = Array.from(items).indexOf(dragItem);
                
                // Сбрасываем флаги
                isScrolling = true;
                dragActivated = false;
                
                // Создаем невидимый плейсхолдер
                placeholder = document.createElement('li');
                placeholder.className = 'ranking-item placeholder';
                dragItem.parentNode.insertBefore(placeholder, dragItem);
            }
            
            // Обработка движения касания
            function handleTouchMove(e) {
                if (!dragItem || e.touches.length !== 1) return;
                
                const touch = Array.from(e.touches).find(t => t.identifier === touchIdentifier);
                if (!touch) return;
                
                currentY = touch.clientY;
                const deltaY = Math.abs(currentY - startY);
                const deltaX = Math.abs(touch.clientX - startX);
                const elapsedTime = Date.now() - touchStartTime;
                
                // Если еще не определились с режимом (скролл или drag)
                if (!dragActivated && isScrolling) {
                    // Если движение преимущественно вертикальное и превышает порог
                    if (deltaY > dragThreshold && deltaY > deltaX) {
                        // Если прошло достаточно времени или движение значительное
                        if (elapsedTime > timeThreshold || deltaY > 20) {
                            activateDrag(touch);
                            e.preventDefault();
                            return;
                        }
                    }
                    
                    // Продолжаем скроллить
                    const scrollDelta = startY - touch.clientY;
                    content.scrollTop = startScrollTop + scrollDelta;
                }
                
                // Если активирован drag
                if (dragActivated) {
                    e.preventDefault();
                    updateDragPosition(touch);
                    updateItemPositions();
                }
            }
            
            // Активация перетаскивания
            function activateDrag(touch) {
                dragActivated = true;
                isScrolling = false;
                isDragging = true;
                hasInteracted = true;
                
                // Скрываем кнопку "Принять текущий порядок" после первого взаимодействия
                if (acceptOrderBtn.parentElement) {
                    acceptOrderBtn.parentElement.remove();
                }
                
                // Добавляем класс для стилизации перетаскиваемого элемента
                dragItem.classList.add('dragging');
                
                // Устанавливаем начальную позицию
                updateDragPosition(touch);
                
                // Активируем оверлей для предотвращения скролла
                dragOverlay.style.display = 'block';
            }
            
            // Обновление позиции перетаскиваемого элемента
            function updateDragPosition(touch) {
                if (!dragItem) return;
                
                const rect = dragItem.getBoundingClientRect();
                const y = touch.clientY - rect.height / 2;
                
                dragItem.style.position = 'fixed';
                dragItem.style.top = `${y}px`;
                dragItem.style.left = '16px';
                dragItem.style.width = `calc(100% - 32px)`;
                dragItem.style.zIndex = '1000';
            }
            
            // Обновление позиций элементов при перетаскивании
            function updateItemPositions() {
                if (!dragItem || !placeholder) return;
                
                const dragRect = dragItem.getBoundingClientRect();
                const dragCenterY = dragRect.top + dragRect.height / 2;
                
                // Находим элемент, над которым находится перетаскиваемый элемент
                let newIndex = -1;
                for (let i = 0; i < items.length; i++) {
                    const item = items[i];
                    if (item === dragItem || item === placeholder) continue;
                    
                    const rect = item.getBoundingClientRect();
                    const itemCenterY = rect.top + rect.height / 2;
                    
                    if (dragCenterY < itemCenterY) {
                        newIndex = i;
                        break;
                    }
                }
                
                // Если не нашли позицию, ставим в конец
                if (newIndex === -1) newIndex = items.length;
                
                // Корректируем индекс с учетом плейсхолдера
                const currentIndex = Array.from(list.children).indexOf(placeholder);
                if (newIndex > currentIndex) newIndex--;
                
                // Перемещаем плейсхолдер на новую позицию
                if (newIndex >= 0 && newIndex <= list.children.length) {
                    if (newIndex < list.children.length) {
                        list.insertBefore(placeholder, list.children[newIndex]);
                    } else {
                        list.appendChild(placeholder);
                    }
                }
            }
            
            // Завершение перетаскивания
            function handleTouchEnd() {
                if (dragActivated && dragItem && placeholder) {
                    // Вставляем элемент на место placeholder'а
                    list.insertBefore(dragItem, placeholder);
                    
                    // Удаляем placeholder
                    list.removeChild(placeholder);
                    
                    // Сбрасываем стили
                    dragItem.classList.remove('dragging');
                    dragItem.style.position = '';
                    dragItem.style.top = '';
                    dragItem.style.left = '';
                    dragItem.style.width = '';
                    dragItem.style.zIndex = '';
                    
                    // Обновляем номера
                    updateItemNumbers();
                    
                    // Активируем кнопку "Продолжить"
                    continueBtn.disabled = false;
                }
                
                // Скрываем оверлей
                dragOverlay.style.display = 'none';
                
                // Сбрасываем состояние
                isDragging = false;
                isScrolling = false;
                dragActivated = false;
                dragItem = null;
                placeholder = null;
                touchIdentifier = null;
            }
            
            // Обновление номеров элементов
            function updateItemNumbers() {
                const currentItems = document.querySelectorAll('.ranking-item:not(.placeholder)');
                currentItems.forEach((item, index) => {
                    const numberElement = item.querySelector('.item-number');
                    if (numberElement) {
                        numberElement.textContent = index + 1;
                    }
                });
            }
            
            // Обработка кнопки "Принять текущий порядок"
            acceptOrderBtn.addEventListener('click', function() {
                updateItemNumbers();
                continueBtn.disabled = false;
                this.parentElement.remove();
            });
            
            // Обработка кнопки "Затрудняюсь ответить"
            difficultAnswerBtn.addEventListener('click', function() {
                // Заменяем цифры на прочерки
                items.forEach(item => {
                    const numberElement = item.querySelector('.item-number');
                    if (numberElement) {
                        const dashElement = document.createElement('div');
                        dashElement.className = 'item-dash';
                        dashElement.textContent = '—';
                        item.replaceChild(dashElement, numberElement);
                    }
                    
                    // Деактивируем элементы
                    item.classList.add('disabled');
                    item.style.touchAction = 'auto';
                    
                    // Удаляем обработчики событий
                    item.removeEventListener('touchstart', handleTouchStart);
                    item.removeEventListener('touchmove', handleTouchMove);
                    item.removeEventListener('touchend', handleTouchEnd);
                    item.removeEventListener('touchcancel', handleTouchEnd);
                });
                
                // Активируем кнопку "Продолжить"
                continueBtn.disabled = false;
                
                // Удаляем кнопку "Принять текущий порядок", если она еще есть
                if (acceptOrderBtn.parentElement) {
                    acceptOrderBtn.parentElement.remove();
                }
            });
            
            // Обработка кнопки "Продолжить"
            continueBtn.addEventListener('click', function() {
                alert('Форма отправлена!');
            });
            
            // Обработка кнопки "Закрыть"
            document.querySelector('.close-btn').addEventListener('click', function() {
                alert('Форма закрыта!');
            });
            
            // Инициализация
            initItems();
        });
    </script>
</body>
</html>
