<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Ранжирование — DnD (long‑press)</title>
  <style>
    :root{
      --bg: #f3f4f6;
      --panel: #ffffff;
      --text: #0f172a;
      --muted: #64748b;
      --outline: #e5e7eb;
      --shadow: 0 8px 24px rgba(2,6,23,.08);
      --drag-shadow: 0 10px 28px rgba(2,6,23,.22);
      --brand: #e34b4b;
      --chip: #4f46e5;
      --chip-muted: #94a3b8;
      --radius: 16px;
      --item-pad-y: 14px;
      --item-gap: 12px;
      --number-size: 28px;
      --press-delay: 260ms;
      --swap-anim: 160ms;
      --scrollbar: 8px;
    }

    html,body{ height:100%; }
    body{ margin:0; background:var(--bg); color:var(--text); font: 16px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }

    .app{ position:fixed; inset:0; display:flex; flex-direction:column; max-width:480px; margin:0 auto; background:var(--bg); }

    .app__header{ position:sticky; top:0; z-index:5; background:var(--panel); border-bottom:1px solid var(--outline); padding:12px 14px; display:flex; gap:10px; align-items:center; }
    .close-btn{ width:28px; height:28px; border-radius:10px; border:1px solid var(--outline); background:#fff; display:grid; place-items:center; }
    .title{ font-weight:700; font-size:16px; }
    .subtitle{ color:var(--muted); font-size:13px; }

    .app__content{ position:relative; flex:1; overflow-y:scroll; -webkit-overflow-scrolling:touch; padding:12px 14px 24px; }
    .app__content::-webkit-scrollbar{ width: var(--scrollbar); }
    .app__content::-webkit-scrollbar-thumb{ background:#cbd5e1; border-radius:20px; }

    .card{ background:var(--panel); border:1px solid var(--outline); border-radius:var(--radius); box-shadow:var(--shadow); padding:12px; }
    .question{ font-weight:700; font-size:15px; margin:4px 0 12px; }

    .rank-list{ list-style:none; padding:0; margin:0; display:flex; flex-direction:column; gap:var(--item-gap); }

    .item{ display:grid; grid-template-columns: 32px 1fr 18px; align-items:center; gap:10px; padding: var(--item-pad-y) 12px; border:1px solid var(--outline); border-radius:14px; background:#fff; touch-action:none; }
    .item[data-dragging="true"]{ background:#5562ff1a; border-color:#c7d2fe; box-shadow:var(--drag-shadow); cursor:grabbing; }

    .num{ width:var(--number-size); height:var(--number-size); border-radius:999px; display:grid; place-items:center; font-size:12px; font-weight:800; color:#fff; background:var(--chip-muted); }
    .num[data-state="dash"]{ background:var(--chip-muted); }
    .num[data-state="number"]{ background:var(--chip); }

    .label{ font-size:14px; color:var(--text); }
    .handle{ opacity:.55; justify-self:end; }

    .controls{ margin-top:14px; display:grid; gap:10px; }
    .check{ display:flex; gap:10px; align-items:center; border:1px solid var(--outline); border-radius:14px; padding:10px 12px; background:#fff; }

    .app__footer{ position:sticky; bottom:0; z-index:5; background:var(--panel); border-top:1px solid var(--outline); padding:12px 14px; display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .cta{ appearance:none; border:none; border-radius:999px; background:var(--brand); color:#fff; font-weight:800; padding:14px 18px; font-size:16px; box-shadow:var(--shadow); }
    .brand{ color:var(--muted); font-size:12px; }

    .disabled{ opacity:.55; pointer-events:none; }
  </style>
</head>
<body>
  <div class="app" id="app">
    <header class="app__header">
      <button class="close-btn" aria-label="Закрыть" onclick="alert('Закрыть (демо)')">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
      <div>
        <div class="title">Распределите варианты в порядке важности</div>
        <div class="subtitle">Сверху — более важный, снизу — менее важный</div>
      </div>
    </header>

    <main class="app__content" id="scrollArea">
      <section class="card" aria-labelledby="q1">
        <h2 class="question" id="q1">Выберите порядок напитков</h2>
        <ol class="rank-list" id="rankList">
          <li class="item"><div class="num" data-state="dash">—</div><div class="label">Крепкий чёрный кофе с молоком и корицей</div><svg class="handle" width="18" height="18" viewBox="0 0 20 20" aria-hidden="true"><g fill="currentColor"><circle cx="5" cy="5" r="1.6"/><circle cx="10" cy="5" r="1.6"/><circle cx="15" cy="5" r="1.6"/><circle cx="5" cy="10" r="1.6"/><circle cx="10" cy="10" r="1.6"/><circle cx="15" cy="10" r="1.6"/><circle cx="5" cy="15" r="1.6"/><circle cx="10" cy="15" r="1.6"/><circle cx="15" cy="15" r="1.6"/></g></svg></li>
          <li class="item"><div class="num" data-state="dash">—</div><div class="label">Традиционный квас с ржаным хлебом и мёдом</div><svg class="handle" width="18" height="18" viewBox="0 0 20 20" aria-hidden="true"><g fill="currentColor"><circle cx="5" cy="5" r="1.6"/><circle cx="10" cy="5" r="1.6"/><circle cx="15" cy="5" r="1.6"/><circle cx="5" cy="10" r="1.6"/><circle cx="10" cy="10" r="1.6"/><circle cx="15" cy="10" r="1.6"/><circle cx="5" cy="15" r="1.6"/><circle cx="10" cy="15" r="1.6"/><circle cx="15" cy="15" r="1.6"/></g></svg></li>
          <li class="item"><div class="num" data-state="dash">—</div><div class="label">Нежный смузи из манго и ананаса</div><svg class="handle" width="18" height="18" viewBox="0 0 20 20" aria-hidden="true"><g fill="currentColor"><circle cx="5" cy="5" r="1.6"/><circle cx="10" cy="5" r="1.6"/><circle cx="15" cy="5" r="1.6"/><circle cx="5" cy="10" r="1.6"/><circle cx="10" cy="10" r="1.6"/><circle cx="15" cy="10" r="1.6"/><circle cx="5" cy="15" r="1.6"/><circle cx="10" cy="15" r="1.6"/><circle cx="15" cy="15" r="1.6"/></g></svg></li>
          <li class="item"><div class="num" data-state="dash">—</div><div class="label">Чай с жасмином и мёдом, поданный горячим</div><svg class="handle" width="18" height="18" viewBox="0 0 20 20" aria-hidden="true"><g fill="currentColor"><circle cx="5" cy="5" r="1.6"/><circle cx="10" cy="5" r="1.6"/><circle cx="15" cy="5" r="1.6"/><circle cx="5" cy="10" r="1.6"/><circle cx="10" cy="10" r="1.6"/><circle cx="15" cy="10" r="1.6"/><circle cx="5" cy="15" r="1.6"/><circle cx="10" cy="15" r="1.6"/><circle cx="15" cy="15" r="1.6"/></g></svg></li>
          <li class="item"><div class="num" data-state="dash">—</div><div class="label">Ароматный чай с лимоном и имбирем</div><svg class="handle" width="18" height="18" viewBox="0 0 20 20" aria-hidden="true"><g fill="currentColor"><circle cx="5" cy="5" r="1.6"/><circle cx="10" cy="5" r="1.6"/><circle cx="15" cy="5" r="1.6"/><circle cx="5" cy="10" r="1.6"/><circle cx="10" cy="10" r="1.6"/><circle cx="15" cy="10" r="1.6"/><circle cx="5" cy="15" r="1.6"/><circle cx="10" cy="15" r="1.6"/><circle cx="15" cy="15" r="1.6"/></g></svg></li>
          <li class="item"><div class="num" data-state="dash">—</div><div class="label">Классический коктейль Мохито с ромом и свежей мятой</div><svg class="handle" width="18" height="18" viewBox="0 0 20 20" aria-hidden="true"><g fill="currentColor"><circle cx="5" cy="5" r="1.6"/><circle cx="10" cy="5" r="1.6"/><circle cx="15" cy="5" r="1.6"/><circle cx="5" cy="10" r="1.6"/><circle cx="10" cy="10" r="1.6"/><circle cx="15" cy="10" r="1.6"/><circle cx="5" cy="15" r="1.6"/><circle cx="10" cy="15" r="1.6"/><circle cx="15" cy="15" r="1.6"/></g></svg></li>
          <li class="item"><div class="num" data-state="dash">—</div><div class="label">Шоколадный фраппе с взбитыми сливками</div><svg class="handle" width="18" height="18" viewBox="0 0 20 20" aria-hidden="true"><g fill="currentColor"><circle cx="5" cy="5" r="1.6"/><circle cx="10" cy="5" r="1.6"/><circle cx="15" cy="5" r="1.6"/><circle cx="5" cy="10" r="1.6"/><circle cx="10" cy="10" r="1.6"/><circle cx="15" cy="10" r="1.6"/><circle cx="5" cy="15" r="1.6"/><circle cx="10" cy="15" r="1.6"/><circle cx="15" cy="15" r="1.6"/></g></svg></li>
          <li class="item"><div class="num" data-state="dash">—</div><div class="label">Классический молочный коктейль с клубникой</div><svg class="handle" width="18" height="18" viewBox="0 0 20 20" aria-hidden="true"><g fill="currentColor"><circle cx="5" cy="5" r="1.6"/><circle cx="10" cy="5" r="1.6"/><circle cx="15" cy="5" r="1.6"/><circle cx="5" cy="10" r="1.6"/><circle cx="10" cy="10" r="1.6"/><circle cx="15" cy="10" r="1.6"/><circle cx="5" cy="15" r="1.6"/><circle cx="10" cy="15" r="1.6"/><circle cx="15" cy="15" r="1.6"/></g></svg></li>
          <li class="item"><div class="num" data-state="dash">—</div><div class="label">Освежающий лимонад с мятой и лаймом</div><svg class="handle" width="18" height="18" viewBox="0 0 20 20" aria-hidden="true"><g fill="currentColor"><circle cx="5" cy="5" r="1.6"/><circle cx="10" cy="5" r="1.6"/><circle cx="15" cy="5" r="1.6"/><circle cx="5" cy="10" r="1.6"/><circle cx="10" cy="10" r="1.6"/><circle cx="15" cy="10" r="1.6"/><circle cx="5" cy="15" r="1.6"/><circle cx="10" cy="15" r="1.6"/><circle cx="15" cy="15" r="1.6"/></g></svg></li>
          <li class="item"><div class="num" data-state="dash">—</div><div class="label">Коктейль Пина Колада с ананасом и кокосом</div><svg class="handle" width="18" height="18" viewBox="0 0 20 20" aria-hidden="true"><g fill="currentColor"><circle cx="5" cy="5" r="1.6"/><circle cx="10" cy="5" r="1.6"/><circle cx="15" cy="5" r="1.6"/><circle cx="5" cy="10" r="1.6"/><circle cx="10" cy="10" r="1.6"/><circle cx="15" cy="10" r="1.6"/><circle cx="5" cy="15" r="1.6"/><circle cx="10" cy="15" r="1.6"/><circle cx="15" cy="15" r="1.6"/></g></svg></li>
        </ol>
        <div class="controls">
          <label class="check" id="acceptBlock"><input type="checkbox" id="acceptOrder" /> Принять текущий порядок</label>
          <label class="check"><input type="checkbox" id="idk" /> Затрудняюсь ответить</label>
        </div>
      </section>
      <div style="height:24px"></div>
    </main>

    <footer class="app__footer">
      <div class="brand">UX Feedback</div>
      <button class="cta" id="submitBtn">Продолжить</button>
    </footer>
  </div>

  <script>
    (function(){
      // ===== State =====
      const listEl = document.getElementById('rankList');
      const scrollArea = document.getElementById('scrollArea');
      const acceptOrder = document.getElementById('acceptOrder');
      const acceptBlock = document.getElementById('acceptBlock');
      const idk = document.getElementById('idk');

      let numbersAssigned = false; // показаны ли номера
      let pressTimer=null, sourceEl=null, draggingEl=null, placeholder=null, offsetY=0, currentY=0, raf=null;
      const PRESS_DELAY = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--press-delay')) || 260;

      // ===== Helpers =====
      function applyNumbers(){
        [...listEl.querySelectorAll('.item')].forEach((el,i)=>{
          const numEl = el.querySelector('.num');
          if(numbersAssigned){ numEl.textContent = i+1; numEl.dataset.state='number'; }
          else { numEl.textContent = '—'; numEl.dataset.state='dash'; }
        });
      }

      function createPlaceholder(h){ const ph=document.createElement('li'); ph.className='placeholder'; ph.style.height=h+'px'; return ph; }

      function flip(fromTops){
        const items = [...listEl.querySelectorAll('.item')];
        items.forEach(el=>{
          const dy = (fromTops.get(el)||0) - el.offsetTop;
          if(dy){
            el.style.transform = `translateY(${dy}px)`;
            el.getBoundingClientRect();
            el.style.transition = 'transform var(--swap-anim) ease';
            el.style.transform = 'translateY(0)';
            setTimeout(()=>{ el.style.transition=''; }, 180);
          }
        });
      }

      // ===== DnD =====
      function onPointerDown(e){
        if(idk.checked) return;
        const li = e.target.closest('.item');
        if(!li) return;
        const startY = (e.touches ? e.touches[0].clientY : e.clientY);
        pressTimer = setTimeout(()=> beginDrag(li, startY), PRESS_DELAY);
        const cancel = ()=>{ clearTimeout(pressTimer); pressTimer=null; window.removeEventListener('pointerup', cancel); window.removeEventListener('touchend', cancel); };
        window.addEventListener('pointerup', cancel, {once:true});
        window.addEventListener('touchend', cancel, {once:true});
      }

      function beginDrag(li, y){
        const rect = li.getBoundingClientRect();
        sourceEl = li; sourceEl.dataset.dragging='true';
        offsetY = y - rect.top; currentY = y;
        placeholder = createPlaceholder(rect.height);
        li.after(placeholder);

        draggingEl = li.cloneNode(true);
        Object.assign(draggingEl.style, { position:'fixed', left:rect.left+'px', top:rect.top+'px', width:rect.width+'px', pointerEvents:'none', zIndex:9999 });
        draggingEl.dataset.dragging='true';
        document.body.appendChild(draggingEl);

        window.addEventListener('pointermove', onMove);
        window.addEventListener('touchmove', onMove, {passive:false});
        window.addEventListener('pointerup', onDrop, {once:true});
        window.addEventListener('touchend', onDrop, {once:true});
        raf = requestAnimationFrame(autoscroll);
      }

      function onMove(e){
        if(!draggingEl) return;
        if(e.cancelable) e.preventDefault();
        currentY = (e.touches ? e.touches[0].clientY : e.clientY);
        draggingEl.style.top = (currentY - offsetY) + 'px';

        // record positions BEFORE reinsert
        const beforeMap = new Map([...listEl.querySelectorAll('.item')].map(el=>[el, el.offsetTop]));

        // compute new position by midpoint
        const others = [...listEl.querySelectorAll('.item')].filter(x=>x!==sourceEl);
        const center = currentY;
        let before=null;
        for(const el of others){
          const r = el.getBoundingClientRect();
          if(center < r.top + r.height/2){ before = el; break; }
        }
        if(before){ listEl.insertBefore(placeholder, before); } else { listEl.appendChild(placeholder); }

        // preview number on the floating chip
        const index = [...listEl.children].indexOf(placeholder);
        const numEl = draggingEl.querySelector('.num');
        if(numEl){ numEl.textContent = index+1; numEl.dataset.state='number'; }

        flip(beforeMap);
      }

      function onDrop(){
        cancelAnimationFrame(raf);
        if(!sourceEl) return;
        const beforeMap = new Map([...listEl.querySelectorAll('.item')].map(el=>[el, el.offsetTop]));
        listEl.insertBefore(sourceEl, placeholder);
        flip(beforeMap);
        cleanupDrag();
        numbersAssigned = true; applyNumbers(); acceptBlock.style.display='none';
      }

      function cleanupDrag(){
        draggingEl && draggingEl.remove(); draggingEl=null;
        placeholder && placeholder.remove(); placeholder=null;
        if(sourceEl){ sourceEl.dataset.dragging='false'; sourceEl=null; }
        window.removeEventListener('pointermove', onMove);
        window.removeEventListener('touchmove', onMove);
      }

      function autoscroll(){
        const edge = 56; const rect = scrollArea.getBoundingClientRect();
        if(currentY < rect.top + edge){ scrollArea.scrollBy({top:-8, behavior:'auto'}); }
        else if(currentY > rect.bottom - edge){ scrollArea.scrollBy({top:8, behavior:'auto'}); }
        raf = requestAnimationFrame(autoscroll);
      }

      // wire
      listEl.addEventListener('pointerdown', onPointerDown);
      listEl.addEventListener('touchstart', onPointerDown, {passive:true});

      // ===== Controls =====
      acceptOrder.addEventListener('change', ()=>{
        if(acceptOrder.checked){ numbersAssigned = true; applyNumbers(); acceptBlock.style.display='none'; }
      });

      idk.addEventListener('change', ()=>{
        if(idk.checked){ numbersAssigned = false; applyNumbers(); listEl.classList.add('disabled'); }
        else { listEl.classList.remove('disabled'); }
      });

      document.getElementById('submitBtn').addEventListener('click', ()=>{
        const order = [...listEl.querySelectorAll('.label')].map(n=>n.textContent.trim());
        alert((numbersAssigned? 'Порядок:' : 'Пока без порядка:') + '

' + order.map((t,i)=>`${i+1}. ${t}`).join('
'));
      });

      // init visuals
      applyNumbers();
    })();
  </script>
</body>
</html>
